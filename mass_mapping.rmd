---
title: "r"
output: html_document
date: "2025-10-22"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(readxl)
library(dplyr)
```

## Theoretical Mass Calculation

```{r}
source("Source/theo_mass_match.r")
source("Source/mass_reversion.r")
df <- read_xlsx("Data/F-Luc_mazF.xlsx")
```

```{r}
df <- add_fragment_mass(df)

# --- Manual cleavage site -> mass mapping ---
manual_masses <- c(
  `6`  = 2232.31796,
  `12` = 1621.25137,
  `27` = 963.14633,
  `28` = 2512.36401
)

# --- Apply manual imputations based on Cleavage site # ---
for (site in names(manual_masses)) {
  df$theo_mass[df$`Cleavage site #` == as.numeric(site)] <- manual_masses[site]
}

df
```

# Match & Map

```{r}
ppm_match <- function(obs, theo, tol = 10) {
  abs((obs - theo) / theo * 1e6) <= tol
}
```

```{r}
exp <- read_xlsx("Data/1st/Fluc_mRNA_MazFalone_251021_old_charge2.xlsx") %>% 
  janitor::clean_names() %>% 
  drop_na() %>% 
  select(monoisotopic_mass, apex_rt, sum_intensity, relative_abundance, number_of_detected_intervals) %>% 
  filter(apex_rt <= 20) %>%                
  arrange(desc(monoisotopic_mass)) %>%
  mutate(
    sum_intensity = as.numeric(sum_intensity),
    relative_abundance = as.numeric(relative_abundance),
    number_of_detected_intervals = as.numeric(number_of_detected_intervals)
  )
```

```{r}
df_matched <- match_by_ppm(
  exp = exp,
  df = df,
  exp_mass_col = "monoisotopic_mass",
  theo_mass_col = "theo_mass",
  intensity_col = "sum_intensity",
  tol = 10
)
```

```{r}
df_matched$mass_diff <- df_matched$theo_mass - df_matched$monoisotopic_mass
library(writexl)
#write_xlsx(df_matched, "Result/matched_mRNA_Fluc_MazF.xlsx")
```

```{r}
exp_unmatched <- find_unmatched(
  df = exp,
  df_matched = df_matched,
  theo_mass_col = "monoisotopic_mass",
  exp_mass_col = "monoisotopic_mass",
  tol = 10
)
```

# Mass reversion

```{r}
df_comp <- find_compositions_ppm(target_mass = 31727.31674, tolerance = 10, max_methyl = 0, max_length = 120)
```

```{r}
mrna_seq <- "GGGAAAUAAGAGAGAAAAGAAGAGUAAGAAGAAAUAUAAGACCCCGGCGCCGCCACCAUGGAAGACGCCAAAAACAUAAAGAAAGGCCCGGCGCCAUUCUAUCCGCUAGAGGAUGGAACCGCUGGAGAGCAACUGCAUAAGGCUAUGAAGAGAUACGCCCUGGUUCCUGGAACAAUUGCUUUUACAGAUGCACAUAUCGAGGUGGACAUCACGUACGCGGAAUACUUCGAAAUGUCCGUUCGGUUGGCAGAAGCUAUGAAACGAUAUGGGCUGAAUACAAAUCACAGAAUCGUCGUAUGCAGUGAAAACUCUCUUCAAUUCUUUAUGCCGGUGUUGGGCGCGUUAUUUAUCGGAGUUGCAGUUGCGCCCGCGAACGACAUUUAUAAUGAACGUGAAUUGCUCAACAGUAUGGGCAUUUCGCAGCCUACCGUAGUGUUUGUUUCCAAAAAGGGGUUGCAAAAAAUUUUGAACGUGCAAAAAAAAUUACCAAUAAUCCAGAAAAUUAUUAUCAUGGAUUCUAAAACGGAUUACCAGGGAUUUCAGUCGAUGUACACGUUCGUCACAUCUCAUCUACCUCCCGGUUUUAAUGAAUACGAUUUUGUACCAGAGUCCUUUGAUCGUGACAAAACAAUUGCACUGAUAAUGAACUCCUCUGGAUCUACUGGGUUACCUAAGGGUGUGGCCCUUCCGCAUAGAACUGCCUGCGUCAGAUUCUCGCAUGCCAGAGAUCCUAUUUUUGGCAAUCAAAUCAUUCCGGAUACUGCGAUUUUAAGUGUUGUUCCAUUCCAUCACGGUUUUGGAAUGUUUACUACACUCGGAUAUUUGAUAUGUGGAUUUCGAGUCGUCUUAAUGUAUAGAUUUGAAGAGGAGCUGUUUUUACGAUCCCUUCAGGAUUACAAAAUUCAAAGUGCGUUGCUAGUACCAACCCUAUUUUCAUUCUUCGCCAAAAGCACUCUGAUUGACAAAUACGAUUUAUCUAAUUUACACGAAAUUGCUUCUGGGGGCGCACCUCUUUCGAAAGAAGUCGGGGAAGCGGUUGCAAAACGCUUCCAUCUUCCAGGGAUACGACAAGGAUAUGGGCUCACUGAGACUACAUCAGCUAUUCUGAUUACACCCGAGGGGGAUGAUAAACCGGGCGCGGUCGGUAAAGUUGUUCCAUUUUUUGAAGCGAAGGUUGUGGAUCUGGAUACCGGGAAAACGCUGGGCGUUAAUCAGAGAGGCGAAUUAUGUGUCAGAGGACCUAUGAUUAUGUCCGGUUAUGUAAACAAUCCGGAAGCGACCAACGCCUUGAUUGACAAGGAUGGAUGGCUACAUUCUGGAGACAUAGCUUACUGGGACGAAGACGAACACUUCUUCAUAGUUGACCGCUUGAAGUCUUUAAUUAAAUACAAAGGAUACCAGGUGGCCCCCGCUGAAUUGGAGUCGAUAUUGUUACAACACCCCAACAUCUUCGACGCGGGCGUGGCAGGUCUUCCCGACGAUGACGCCGGUGAACUUCCCGCCGCCGUUGUUGUUUUGGAGCACGGAAAGACGAUGACGGAAAAAGAGAUCGUGGAUUACGUCGCCAGUCAAGUAACAACCGCGAAAAAGUUGCGCGGAGGAGUUGUGUUUGUGGACGAAGUACCGAAAGGUCUUACCGGAAAACUCGACGCAAGAAAAAUCAGAGAGAUCCUCAUAAAGGCCAAGAAGGGCGGAAAGAUCGCCGUGUGAUAAUAGGCUGGAGCCUCGGUGGCCUAGCUUCUUGCCCCUUGGGCCUCCCCCCAGCCCCUCCUCCCCUUCCUGCACCCGUACCCCCGUGGUCUUUGAAUAAAGUCUGAGUGGGCGGCAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAGCAUAUGACUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUGAA"
```

```{r}
seq_matched <- find_matching_compositions(
  seq = mrna_seq,  
  df_comp = df_comp   
)
```

# Visualization

```{r}
library(ggplot2)
# Color scale
cold_to_warm <- c("#2c7bb6", "#00a6ca", "#ffffbf", "#fdae61", "#d7191c")

ggplot() +
  # Grey points from exp_grey
  geom_point(data = exp, aes(x = monoisotopic_mass, y = apex_rt),
             color = "grey", size = 1, alpha = 0.6) +
  
  # Colored points from df_matched
  geom_point(data = df_matched, aes(x = monoisotopic_mass, y = apex_rt, color = log10(sum_intensity)),
             size = 3, alpha = 0.85) +
  
  # Color scale for df_matched points
  scale_color_gradientn(
    colours = cold_to_warm,
    name = "Log (Intensity)",
    guide = guide_colorbar(
      title.position = "top",
      title.hjust = 0.5,
      barwidth = unit(0.5, "cm"),
      barheight = unit(2, "cm")
    )
  ) +
  
  # Theme and labels
  theme_minimal() +
  theme(
    panel.grid = element_blank(),
    legend.position = "right",
    legend.title = element_text(size = 10, face = "bold"),
    legend.text = element_text(size = 9),
    axis.line = element_line(color = "black", linewidth = 0.4),
    plot.title = element_text(size = 12, face = "bold", hjust = 0.5)
  ) +
  labs(
    x = "Mass (Da)",
    y = "Retention Time (min)",
    title = "Matched Mass vs Retention Time"
  )

```

```{r}
# Plot
ggplot() +
  # Background: all experimental points in grey
  geom_point(
    data = exp,
    aes(x = monoisotopic_mass, y = relative_abundance),
    color = "grey80", size = 2, alpha = 0.6
  ) +
  # Foreground: matched points in color
  geom_point(
    data = df_matched,
    aes(x = monoisotopic_mass, y = relative_abundance, color = relative_abundance),
    size = 3, alpha = 0.9
  ) +
  scale_color_gradientn(
    colours = cold_to_warm,
    name = "Relative Abundance",
    guide = guide_colorbar(
      title.position = "top",
      title.hjust = 0.5,
      barwidth = unit(0.5, "cm"),
      barheight = unit(2, "cm")
    )
  ) +
  theme_minimal() +
  theme(
    panel.grid = element_blank(),
    legend.position = "right",
    legend.title = element_text(size = 10, face = "bold"),
    legend.text = element_text(size = 9),
    axis.line = element_line(color = "black", linewidth = 0.4),
    plot.title = element_text(size = 12, face = "bold", hjust = 0.5)
  ) +
  labs(
    x = "Mass (Da)",
    y = "Relative Abundance",
    title = "Matched Mass vs Relative Abundance"
  )

```

