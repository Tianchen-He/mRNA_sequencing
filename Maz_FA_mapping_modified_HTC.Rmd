---
title: "Maz FA Mapping for Modified mRNA"
author: "Tianchen He"
date: "2025-11-6"
output: html_document
---

```{r setup, include=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# Add the function for ppm calculation
ppm = function(observed, theo){
  if(abs((observed - theo) / theo * 10^6) > 10) {
    return(FALSE)
  } else {
    return(TRUE)
  }
}

source("Source/introduction.R")
source("Source/blind_seq.R")
source("Source/plotting.R")
source("Source/advanced_plotting.R")

# get your dictionary file ready
dictionary = read_xlsx("Data/uni_dictionary.xlsx")
options(scipen = 999)

dictionary = dictionary[c(1, 3, 4, 7),]  # Only A, C, G, u
```

## set_up for modified mRNA

```{r}
seq_clean <- gsub(" ", "", "A	C	A	C	C	G	C	U	A	U	C	C	U	C	A	G	C	G	U	G	G	U	G	C	C	A	U	U	U	C	A C	C	A	C	G	G	C	U	U	C	G	G	C	A	U	G	U	U	C	A	C	C	A	C	G	C	U	G	G	G	C	U	A	C	U	U	G	A	U	C	U	G	C	G	G	C	U	U	U	C G	G	G	U	C	G	U	G	C	U	C	A	U	G	U	A	C	C	G	C	U	U	C	G	A	G	G	A	G	G	A	G	C	U	A	U	U	C	U	U	G	C	G	C	A	G	C	U	U	G C	A	A	G	A	C	U	A	U	A	A	G	A	U	U	C	A	A	U	C	U	G	C	C	C	U	G	C	U	G	G	U	G	C	C	C")

set_up("mRNA", 
       chartr("U", "u", seq_clean), 
       "Data/MazF_AD_modified/ModifiedmRNA_SG_MazF1FA5min_T02_251023_SG_xiaohong.xlsx", 
       "peptide", 
       24000, 0, 30) 
```

## Add a cap at theo_5

```{r}
# theo_5 with Cap
theo_5 <- theo_5 %>%
  mutate(
    base_name = ifelse(n_position == 0, "Cap", base_name),
    theoretical_mass = ifelse(
      n_position == 0,
      537.0063,
      theoretical_mass - 18.0150 + 537.0063
    )
  )
```

## Mapping

```{r adduct_finder}
# 记得改长度、文件名字！！！
new_theo_5 = theo_creater(df, theo_5, 0, "native 5'", 167, TRUE)
theo_5_dehydrated = theo_creater(df, theo_5, -18.0106, "dehydrated 5'", 167, TRUE)

new_theo_3 = theo_creater(df, theo_3, 0, "native 3'", 167, FALSE)
theo_3_dehydrated = theo_creater(df, theo_3, -18.0106, "dehydrated 3'", 167, FALSE)

length(unique(rbind(new_theo_5, theo_5_dehydrated, new_theo_3, theo_3_dehydrated)$position_5))

write_xlsx(rbind(new_theo_5, theo_5_dehydrated, new_theo_3, theo_3_dehydrated), "Result/HTC/Modified_mRNA/MazF_FA_mapping/Seq_770_936.xlsx")
```

## Plot

```{r}
palette = read_xlsx("Result/HTC/Modified_mRNA/Seq_1758_1781.xlsx") %>% 
  mutate(monoisotopic_mass = as.numeric(monoisotopic_mass), apex_rt = as.numeric(apex_rt)) %>% 
  select(monoisotopic_mass, apex_rt, ladder_type) %>% 
  drop_na() %>% 
  filter(ladder_type %in% c("native 5'", "dehydrated 5'"))
#  filter(ladder_type %in% c("native 3'", "dehydrated 3'"))

p <- ggplot(palette, aes(x = monoisotopic_mass, y = apex_rt, color = ladder_type)) +
  geom_line(aes(group = ladder_type),color = "gray", size = 1) +
  geom_point(
        alpha=0.9,
        size=2) +
  theme_bw() +
  labs(
    x = "Monoisotopic Mass(Da)",
    y = "Rentention Time(min)"
  ) +
  theme(plot.title = element_text(
      size = 14,        
      face = "bold",    
      hjust = 0.5       # Horizontal justification (0 = left, 0.5 = center, 1 = right)
    )
  ) +
  scale_x_continuous(
    breaks = c(2500, 5000, 7500, 10000, 12500, 15000, 17500, 20000, 22500, 25000),
    limits = c(0, 10000)
  ) +
  scale_y_continuous(
    breaks = c(2, 4, 6, 8, 10, 12, 14, 16, 18, 20)
  )
p
ggsave("Result/HTC/Modified_mRNA/MazF_FA_mapping/Seq_1074_1101_5'.png", plot = p, width = 12, height = 6, dpi = 300)
```

## De novo

```{r}
dictionary = dictionary[c(1, 3, 4, 7),]

prophet_5 = prophet(df, theo_5) #this will be the data frame for matching result, name it whatever you want
prophet_3 = prophet(df, theo_3) #this will be the data frame for matching result, name it whatever you want

# first variable: your data frame
# second variable: your dictionary
algorithm_output = blind_seq(df, dictionary)

# first variable: the output data frame from nested algorithm
# second variable: the minimum length for ladders you want to include in your result file
# third variable: the location of your original data file
output_ladders_found(algorithm_output, 3,  file_location)
```


```{r}
files <- list.files("Result/HTC/Modified_mRNA/MazF_FA_mapping", pattern = "\\.xlsx$", full.names = TRUE)
overlay <- files %>%
  lapply(read_excel) %>%
  bind_rows()
```

```{r}
library(ggplot2)
# Color scale
cold_to_warm <- c("#2c7bb6", "#00a6ca", "#ffffbf", "#fdae61", "#d7191c")

ggplot() +
  # Grey points from exp_grey
  geom_point(data = df, aes(x = monoisotopic_mass, y = apex_rt),
             color = "grey", size = 2, alpha = 0.6) +
  
  # Colored points from df_matched
  geom_point(data = overlay, aes(x = monoisotopic_mass, y = apex_rt, color = log10(sum_intensity)),
             size = 2.5, alpha = 0.85) +
  
  # Color scale for df_matched points
  scale_color_gradientn(
    colours = cold_to_warm,
    name = "Log (Intensity)",
    guide = guide_colorbar(
      title.position = "top",
      title.hjust = 0.5,
      barwidth = unit(0.5, "cm"),
      barheight = unit(2, "cm")
    )
  ) +
  
  # Theme and labels
  theme_minimal() +
  theme(
    panel.grid = element_blank(),
    legend.position = "right",
    legend.title = element_text(size = 10, face = "bold"),
    legend.text = element_text(size = 9),
    axis.line = element_line(color = "black", linewidth = 0.4),
    plot.title = element_text(size = 12, face = "bold", hjust = 0.5)
  ) +
  labs(
    x = "Mass (Da)",
    y = "Retention Time (min)",
    title = "Matched Mass vs Retention Time"
  )

```

```{r}
ggplot() +
  # Background: all experimental points in grey
  geom_point(
    data = df,
    aes(x = monoisotopic_mass, y = relative_abundance),
    color = "grey80", size = 2, alpha = 0.6
  ) +
  # Foreground: matched points in color
  geom_point(
    data = overlay,
    aes(x = monoisotopic_mass, y = relative_abundance, color = relative_abundance),
    size = 2.5, alpha = 0.9
  ) +
  scale_color_gradientn(
    colours = cold_to_warm,
    name = "Relative Abundance",
    guide = guide_colorbar(
      title.position = "top",
      title.hjust = 0.5,
      barwidth = unit(0.5, "cm"),
      barheight = unit(2, "cm")
    )
  ) +
  theme_minimal() +
  theme(
    panel.grid = element_blank(),
    legend.position = "right",
    legend.title = element_text(size = 10, face = "bold"),
    legend.text = element_text(size = 9),
    axis.line = element_line(color = "black", linewidth = 0.4),
    plot.title = element_text(size = 12, face = "bold", hjust = 0.5)
  ) +
  labs(
    x = "Mass (Da)",
    y = "Relative Abundance",
    title = "Matched Mass vs Relative Abundance"
  )

```

