---
title: "Theoretical Mass Match for Modified mRNA"
output: html_document
date: "2025-11-4"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(readxl)
library(dplyr)
library(writexl)

source("Source/theo_mass_match_modified.R")
```

# Draw the coverage xlsx
```{r}
write_mRNA_to_xlsx <- function(seq_str, out_path = "mRNA_grid.xlsx") {
  # Input checks
  if (!is.character(seq_str) || length(seq_str) != 1) {
    stop("seq_str must be a single character string.")
  }
  if (grepl("[^ACGU]", seq_str)) {
    stop("seq_str must contain only A/C/G/U (uppercase).")
  }

  # Split into individual bases
  bases <- unlist(strsplit(seq_str, split = ""))
  n <- length(bases)
  
  # Break into rows of 50 bases each
  chunk_size <- 50
  num_rows <- ceiling(n / chunk_size)
  
  # Create a matrix (fill by row)
  mat <- matrix(NA_character_, nrow = num_rows, ncol = chunk_size)
  for (i in seq_len(n)) {
    row <- ceiling(i / chunk_size)
    col <- ((i - 1) %% chunk_size) + 1
    mat[row, col] <- bases[i]
  }
  
  # Convert to data.frame for writing
  df <- as.data.frame(mat, stringsAsFactors = FALSE)
  
  # Write to Excel
  if (!requireNamespace("writexl", quietly = TRUE)) {
    stop("Please install the 'writexl' package first: install.packages('writexl')")
  }
  writexl::write_xlsx(df, path = out_path)
  
  message("✅ Excel file created: ", normalizePath(out_path))
  invisible(df)
}

write_mRNA_to_xlsx("GGAUGGACUACGACAUAGUCUAGUCCGCCAAGUCUAGAACAAGUUUGUACAAAAAAGCAGGCUGCCACCAUGGAAGAUGCCAAAAACAUUAAGAAGGGCCCAGCGCCAUUCUACCCACUCGAAGACGGGACCGCCGGCGAGCAGCUGCACAAAGCCAUGAAGCGCUACGCCCUGGUGCCCGGCACCAUCGCCUUUACCGACGCACAUAUCGAGGUGGACAUUACCUACGCCGAGUACUUCGAGAUGAGCGUUCGGCUGGCAGAAGCUAUGAAGCGCUAUGGGCUGAAUACAAACCAUCGGAUCGUGGUGUGCAGCGAGAAUAGCUUGCAGUUCUUCAUGCCCGUGUUGGGUGCCCUGUUCAUCGGUGUGGCUGUGGCCCCAGCUAACGACAUCUACAACGAGCGCGAGCUGCUGAACAGCAUGGGCAUCAGCCAGCCCACCGUCGUAUUCGUGAGCAAGAAAGGGCUGCAAAAGAUCCUCAACGUGCAAAAGAAGCUACCGAUCAUACAAAAGAUCAUCAUCAUGGAUAGCAAGACCGACUACCAGGGCUUCCAAAGCAUGUACACCUUCGUGACUUCCCAUUUGCCACCCGGCUUCAACGAGUACGACUUCGUGCCCGAGAGCUUCGACCGGGACAAAACCAUCGCCCUGAUCAUGAACAGUAGUGGCAGUACCGGAUUGCCCAAGGGCGUAGCCCUACCGCACCGCACCGCUUGUGUCCGAUUCAGUCAUGCCCGCGACCCCAUCUUCGGCAACCAGAUCAUCCCCGACACCGCUAUCCUCAGCGUGGUGCCAUUUCACCACGGCUUCGGCAUGUUCACCACGCUGGGCUACUUGAUCUGCGGCUUUCGGGUCGUGCUCAUGUACCGCUUCGAGGAGGAGCUAUUCUUGCGCAGCUUGCAAGACUAUAAGAUUCAAUCUGCCCUGCUGGUGCCCACACUAUUUAGCUUCUUCGCUAAGAGCACUCUCAUCGACAAGUACGACCUAAGCAACUUGCACGAGAUCGCCAGCGGCGGGGCGCCGCUCAGCAAGGAGGUAGGUGAGGCCGUGGCCAAACGCUUCCACCUACCAGGCAUCCGCCAGGGCUACGGCCUGACAGAAACAACCAGCGCCAUUCUGAUCACCCCCGAAGGGGACGACAAGCCUGGCGCAGUAGGCAAGGUGGUGCCCUUCUUCGAGGCUAAGGUGGUGGACUUGGACACCGGUAAGACACUGGGUGUGAACCAGCGCGGCGAGCUGUGCGUCCGUGGCCCCAUGAUCAUGAGCGGCUACGUUAACAACCCCGAGGCUACAAACGCUCUCAUCGACAAGGACGGCUGGCUGCACAGCGGCGACAUCGCCUACUGGGACGAGGACGAGCACUUCUUCAUCGUGGACCGGCUGAAGAGCCUGAUCAAAUACAAGGGCUACCAGGUAGCCCCAGCCGAACUGGAGAGCAUCCUGCUGCAACACCCCAACAUCUUCGACGCCGGGGUCGCCGGCCUGCCCGACGACGAUGCCGGCGAGCUGCCCGCCGCAGUCGUCGUGCUGGAACACGGUAAAACCAUGACCGAGAAGGAGAUCGUGGACUAUGUGGCCAGCCAGGUUACAACCGCCAAGAAGCUGCGCGGUGGUGUUGUGUUCGUGGACGAGGUGCCUAAAGGACUGACCGGCAAGUUGGACGCCCGCAAGAUCCGCGAGAUUCUCAUUAAGGCCAAGAAGGGCGGCAAGAUCGCCGUGUAAACCCAGCUUUCUUGUACAAAGUGGUGGCGCGCCAUACAGCAGCAAUUGGCAAGCUGCUUACAUAGAACUCGCGGCGAUUGGCAUGCCGCCUUAAAAUUUUUAUUUUAUUUUUCUUUUCUUUUCCGAAUCGGAUUUUGUUUUUAAUAUUUCCGCGCCUAUGUUACGUGCAAAGGUGAUUGUCACCCCCCGAAAGACCAUAUUGUGACACACCCUCAGUAUCACGCCCAAACAUUUACAGCCGCGGUGUCAAAAACCGCGUGGACGUGGUUAACAUCCCUGCUGGGAGGAUCAGCCGUAAUUAUUAUAAUUGGCUUGGUGCUGGCUACUAUUGUGGCCAUGUACGUGCUGACCAACCAGAAACAUAAUUGAAUACAGCAGCAAUUGGCAAGCUGCUUACAUAGAACUCGCGGCGAUUGGCAUGCCGCCUUAAAAUUUUUAUUUUAUUUUUCUUUUCUUUUCCGAAUCGGAUUUUGUUUUUAAUAUUUCAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUAGGGAUAACAGGGU", "Modified_mRNA_coverage.xlsx")
```

# Theoretical Mass Calculation

```{r}
df <- generate_modified_fragments("GGAUGGACUACGACAUAGUCUAGUCCGCCAAGUCUAGAACAAGUUUGUACAAAAAAGCAGGCUGCCACCAUGGAAGAUGCCAAAAACAUUAAGAAGGGCCCAGCGCCAUUCUACCCACUCGAAGACGGGACCGCCGGCGAGCAGCUGCACAAAGCCAUGAAGCGCUACGCCCUGGUGCCCGGCACCAUCGCCUUUACCGACGCACAUAUCGAGGUGGACAUUACCUACGCCGAGUACUUCGAGAUGAGCGUUCGGCUGGCAGAAGCUAUGAAGCGCUAUGGGCUGAAUACAAACCAUCGGAUCGUGGUGUGCAGCGAGAAUAGCUUGCAGUUCUUCAUGCCCGUGUUGGGUGCCCUGUUCAUCGGUGUGGCUGUGGCCCCAGCUAACGACAUCUACAACGAGCGCGAGCUGCUGAACAGCAUGGGCAUCAGCCAGCCCACCGUCGUAUUCGUGAGCAAGAAAGGGCUGCAAAAGAUCCUCAACGUGCAAAAGAAGCUACCGAUCAUACAAAAGAUCAUCAUCAUGGAUAGCAAGACCGACUACCAGGGCUUCCAAAGCAUGUACACCUUCGUGACUUCCCAUUUGCCACCCGGCUUCAACGAGUACGACUUCGUGCCCGAGAGCUUCGACCGGGACAAAACCAUCGCCCUGAUCAUGAACAGUAGUGGCAGUACCGGAUUGCCCAAGGGCGUAGCCCUACCGCACCGCACCGCUUGUGUCCGAUUCAGUCAUGCCCGCGACCCCAUCUUCGGCAACCAGAUCAUCCCCGACACCGCUAUCCUCAGCGUGGUGCCAUUUCACCACGGCUUCGGCAUGUUCACCACGCUGGGCUACUUGAUCUGCGGCUUUCGGGUCGUGCUCAUGUACCGCUUCGAGGAGGAGCUAUUCUUGCGCAGCUUGCAAGACUAUAAGAUUCAAUCUGCCCUGCUGGUGCCCACACUAUUUAGCUUCUUCGCUAAGAGCACUCUCAUCGACAAGUACGACCUAAGCAACUUGCACGAGAUCGCCAGCGGCGGGGCGCCGCUCAGCAAGGAGGUAGGUGAGGCCGUGGCCAAACGCUUCCACCUACCAGGCAUCCGCCAGGGCUACGGCCUGACAGAAACAACCAGCGCCAUUCUGAUCACCCCCGAAGGGGACGACAAGCCUGGCGCAGUAGGCAAGGUGGUGCCCUUCUUCGAGGCUAAGGUGGUGGACUUGGACACCGGUAAGACACUGGGUGUGAACCAGCGCGGCGAGCUGUGCGUCCGUGGCCCCAUGAUCAUGAGCGGCUACGUUAACAACCCCGAGGCUACAAACGCUCUCAUCGACAAGGACGGCUGGCUGCACAGCGGCGACAUCGCCUACUGGGACGAGGACGAGCACUUCUUCAUCGUGGACCGGCUGAAGAGCCUGAUCAAAUACAAGGGCUACCAGGUAGCCCCAGCCGAACUGGAGAGCAUCCUGCUGCAACACCCCAACAUCUUCGACGCCGGGGUCGCCGGCCUGCCCGACGACGAUGCCGGCGAGCUGCCCGCCGCAGUCGUCGUGCUGGAACACGGUAAAACCAUGACCGAGAAGGAGAUCGUGGACUAUGUGGCCAGCCAGGUUACAACCGCCAAGAAGCUGCGCGGUGGUGUUGUGUUCGUGGACGAGGUGCCUAAAGGACUGACCGGCAAGUUGGACGCCCGCAAGAUCCGCGAGAUUCUCAUUAAGGCCAAGAAGGGCGGCAAGAUCGCCGUGUAAACCCAGCUUUCUUGUACAAAGUGGUGGCGCGCCAUACAGCAGCAAUUGGCAAGCUGCUUACAUAGAACUCGCGGCGAUUGGCAUGCCGCCUUAAAAUUUUUAUUUUAUUUUUCUUUUCUUUUCCGAAUCGGAUUUUGUUUUUAAUAUUUCCGCGCCUAUGUUACGUGCAAAGGUGAUUGUCACCCCCCGAAAGACCAUAUUGUGACACACCCUCAGUAUCACGCCCAAACAUUUACAGCCGCGGUGUCAAAAACCGCGUGGACGUGGUUAACAUCCCUGCUGGGAGGAUCAGCCGUAAUUAUUAUAAUUGGCUUGGUGCUGGCUACUAUUGUGGCCAUGUACGUGCUGACCAACCAGAAACAUAAUUGAAUACAGCAGCAAUUGGCAAGCUGCUUACAUAGAACUCGCGGCGAUUGGCAUGCCGCCUUAAAAUUUUUAUUUUAUUUUUCUUUUCUUUUCCGAAUCGGAUUUUGUUUUUAAUAUUUCAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUAGGGAUAACAGGGU")

df
```

```{r}
df <- add_fragment_mass_Me(df)

df

# write_xlsx(df, "Result/NIST_modified_MazF_cleavage_result.xlsx")
```

# Match & Map

```{r}
ppm_match <- function(obs, theo, tol = 10) {
  abs((obs - theo) / theo * 1e6) <= tol
}
```

```{r}
exp <- read_xlsx("Data/MazF_modified/modifFluc_mRNA_MazFalone_251021_oldcharge2.xlsx") %>%
  janitor::clean_names() %>% 
  drop_na() %>% 
  select(monoisotopic_mass, apex_rt, sum_intensity, relative_abundance, number_of_detected_intervals) %>% 
  filter(apex_rt <= 20) %>%                
  arrange(desc(monoisotopic_mass)) %>%
  mutate(
    sum_intensity = as.numeric(sum_intensity),
    relative_abundance = as.numeric(relative_abundance),
    number_of_detected_intervals = as.numeric(number_of_detected_intervals)
  )
```

```{r}
df_matched <- match_by_ppm(
  exp = exp,
  df = df,
  exp_mass_col = "monoisotopic_mass",
  theo_mass_col = "theo_mass_modified",
  intensity_col = "sum_intensity",
  tol = 10
)
```

```{r}
df_matched$mass_diff <- df_matched$theo_mass_modified - df_matched$monoisotopic_mass

df_matched
# write_xlsx(df_matched, "Result/HTC/Modified_mRNA/mass_matched_modified_Xiaohong_new.xlsx")
```

```{r}
exp_unmatched <- find_unmatched(
  df = exp,
  df_matched = df_matched,
  theo_mass_col = "monoisotopic_mass",
  exp_mass_col = "monoisotopic_mass",
  tol = 10
)

exp_unmatched
# write_xlsx(exp_unmatched, "Result/HTC/Modified_mRNA/exp_umatched_modified.xlsx")
```

# Match experimental masses to theoretical fragments by ±14 Da increments

```{r}
source("Source/theo_mass_match_modified.R")

res <- match_by_14_multiples(exp_unmatched, df)
res
```

# Mass reversion

```{r}
mrna_seq <- "GGAUGGACUACGACAUAGUCUAGUCCGCCAAGUCUAGAACAAGUUUGUACAAAAAAGCAGGCUGCCACCAUGGAAGAUGCCAAAAACAUUAAGAAGGGCCCAGCGCCAUUCUACCCACUCGAAGACGGGACCGCCGGCGAGCAGCUGCACAAAGCCAUGAAGCGCUACGCCCUGGUGCCCGGCACCAUCGCCUUUACCGACGCACAUAUCGAGGUGGACAUUACCUACGCCGAGUACUUCGAGAUGAGCGUUCGGCUGGCAGAAGCUAUGAAGCGCUAUGGGCUGAAUACAAACCAUCGGAUCGUGGUGUGCAGCGAGAAUAGCUUGCAGUUCUUCAUGCCCGUGUUGGGUGCCCUGUUCAUCGGUGUGGCUGUGGCCCCAGCUAACGACAUCUACAACGAGCGCGAGCUGCUGAACAGCAUGGGCAUCAGCCAGCCCACCGUCGUAUUCGUGAGCAAGAAAGGGCUGCAAAAGAUCCUCAACGUGCAAAAGAAGCUACCGAUCAUACAAAAGAUCAUCAUCAUGGAUAGCAAGACCGACUACCAGGGCUUCCAAAGCAUGUACACCUUCGUGACUUCCCAUUUGCCACCCGGCUUCAACGAGUACGACUUCGUGCCCGAGAGCUUCGACCGGGACAAAACCAUCGCCCUGAUCAUGAACAGUAGUGGCAGUACCGGAUUGCCCAAGGGCGUAGCCCUACCGCACCGCACCGCUUGUGUCCGAUUCAGUCAUGCCCGCGACCCCAUCUUCGGCAACCAGAUCAUCCCCGACACCGCUAUCCUCAGCGUGGUGCCAUUUCACCACGGCUUCGGCAUGUUCACCACGCUGGGCUACUUGAUCUGCGGCUUUCGGGUCGUGCUCAUGUACCGCUUCGAGGAGGAGCUAUUCUUGCGCAGCUUGCAAGACUAUAAGAUUCAAUCUGCCCUGCUGGUGCCCACACUAUUUAGCUUCUUCGCUAAGAGCACUCUCAUCGACAAGUACGACCUAAGCAACUUGCACGAGAUCGCCAGCGGCGGGGCGCCGCUCAGCAAGGAGGUAGGUGAGGCCGUGGCCAAACGCUUCCACCUACCAGGCAUCCGCCAGGGCUACGGCCUGACAGAAACAACCAGCGCCAUUCUGAUCACCCCCGAAGGGGACGACAAGCCUGGCGCAGUAGGCAAGGUGGUGCCCUUCUUCGAGGCUAAGGUGGUGGACUUGGACACCGGUAAGACACUGGGUGUGAACCAGCGCGGCGAGCUGUGCGUCCGUGGCCCCAUGAUCAUGAGCGGCUACGUUAACAACCCCGAGGCUACAAACGCUCUCAUCGACAAGGACGGCUGGCUGCACAGCGGCGACAUCGCCUACUGGGACGAGGACGAGCACUUCUUCAUCGUGGACCGGCUGAAGAGCCUGAUCAAAUACAAGGGCUACCAGGUAGCCCCAGCCGAACUGGAGAGCAUCCUGCUGCAACACCCCAACAUCUUCGACGCCGGGGUCGCCGGCCUGCCCGACGACGAUGCCGGCGAGCUGCCCGCCGCAGUCGUCGUGCUGGAACACGGUAAAACCAUGACCGAGAAGGAGAUCGUGGACUAUGUGGCCAGCCAGGUUACAACCGCCAAGAAGCUGCGCGGUGGUGUUGUGUUCGUGGACGAGGUGCCUAAAGGACUGACCGGCAAGUUGGACGCCCGCAAGAUCCGCGAGAUUCUCAUUAAGGCCAAGAAGGGCGGCAAGAUCGCCGUGUAAACCCAGCUUUCUUGUACAAAGUGGUGGCGCGCCAUACAGCAGCAAUUGGCAAGCUGCUUACAUAGAACUCGCGGCGAUUGGCAUGCCGCCUUAAAAUUUUUAUUUUAUUUUUCUUUUCUUUUCCGAAUCGGAUUUUGUUUUUAAUAUUUCCGCGCCUAUGUUACGUGCAAAGGUGAUUGUCACCCCCCGAAAGACCAUAUUGUGACACACCCUCAGUAUCACGCCCAAACAUUUACAGCCGCGGUGUCAAAAACCGCGUGGACGUGGUUAACAUCCCUGCUGGGAGGAUCAGCCGUAAUUAUUAUAAUUGGCUUGGUGCUGGCUACUAUUGUGGCCAUGUACGUGCUGACCAACCAGAAACAUAAUUGAAUACAGCAGCAAUUGGCAAGCUGCUUACAUAGAACUCGCGGCGAUUGGCAUGCCGCCUUAAAAUUUUUAUUUUAUUUUUCUUUUCUUUUCCGAAUCGGAUUUUGUUUUUAAUAUUUCAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAUAGGGAUAACAGGGU"
```

```{r}
df_comp <- find_compositions_ppm_modified(target_mass = 20427.951, tolerance = 10, max_length = 120)

seq_matched <- find_matching_compositions_modified(
  seq = mrna_seq,  
  df_comp = df_comp   
)

seq_matched
```

# Visualization

```{r}
library(ggplot2)
# Color scale
cold_to_warm <- c("#2c7bb6", "#00a6ca", "#ffffbf", "#fdae61", "#d7191c")

ggplot() +
  # Grey points from exp_grey
  geom_point(data = exp, aes(x = monoisotopic_mass, y = apex_rt),
             color = "grey", size = 2, alpha = 0.6) +
  
  # Colored points from df_matched
  geom_point(data = df_matched, aes(x = monoisotopic_mass, y = apex_rt, color = log10(sum_intensity)),
             size = 2.5, alpha = 0.85) +
  
  # Color scale for df_matched points
  scale_color_gradientn(
    colours = cold_to_warm,
    name = "Log (Intensity)",
    guide = guide_colorbar(
      title.position = "top",
      title.hjust = 0.5,
      barwidth = unit(0.5, "cm"),
      barheight = unit(2, "cm")
    )
  ) +
  
  # Theme and labels
  theme_minimal() +
  theme(
    panel.grid = element_blank(),
    legend.position = "right",
    legend.title = element_text(size = 10, face = "bold"),
    legend.text = element_text(size = 9),
    axis.line = element_line(color = "black", linewidth = 0.4),
    plot.title = element_text(size = 12, face = "bold", hjust = 0.5)
  ) +
  labs(
    x = "Mass (Da)",
    y = "Retention Time (min)",
    title = "Matched Mass vs Retention Time"
  )

```

```{r}
# Plot
ggplot() +
  # Background: all experimental points in grey
  geom_point(
    data = exp,
    aes(x = monoisotopic_mass, y = relative_abundance),
    color = "grey80", size = 2, alpha = 0.6
  ) +
  # Foreground: matched points in color
  geom_point(
    data = df_matched,
    aes(x = monoisotopic_mass, y = relative_abundance, color = relative_abundance),
    size = 2.5, alpha = 0.9
  ) +
  scale_color_gradientn(
    colours = cold_to_warm,
    name = "Relative Abundance",
    guide = guide_colorbar(
      title.position = "top",
      title.hjust = 0.5,
      barwidth = unit(0.5, "cm"),
      barheight = unit(2, "cm")
    )
  ) +
  theme_minimal() +
  theme(
    panel.grid = element_blank(),
    legend.position = "right",
    legend.title = element_text(size = 10, face = "bold"),
    legend.text = element_text(size = 9),
    axis.line = element_line(color = "black", linewidth = 0.4),
    plot.title = element_text(size = 12, face = "bold", hjust = 0.5)
  ) +
  labs(
    x = "Mass (Da)",
    y = "Relative Abundance",
    title = "Matched Mass vs Relative Abundance"
  )

```


